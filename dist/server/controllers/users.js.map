{"version":3,"sources":["../../../server/controllers/users.js"],"names":["UserController","jwt","bcrypt","env","queries","postUser","bind","loginUser","getAUser","req","res","salt","genSaltSync","registeredUser","addUser","insertUser","on","row","push","done","user","token","sign","user_id","SECRET_KEY","expiresIn","status","send","errorMessage","body","compareSync","password","trim","entries","getEntries","getAllEntries"],"mappings":"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","file":"users.js","sourcesContent":["/**\n * @fileOverview this JS file contains logic for user's APIs logic\n *\n * @author  Victor Ukafor\n * @requires  NPM:jsonwebtoken\n * @requires  NPM:bcrypt\n * @version 1.0.0\n *\n */\n\n/**\n  *  class UserController\n  *\n  */\nexport default class UserController {\n/**\n  *  constructor\n  *  Takes 4 parameters\n  *  @param {object} jwt the first parameter\n  *  @param  {object} bcrypt the second parameter\n  *  @param  {object} env the third parameter\n  *  @param  {object} queries the fourth parameter\n  *\n  */\n  constructor(jwt, bcrypt, env, queries) {\n    this.jwt = jwt;\n    this.bcrypt = bcrypt;\n    this.env = env;\n    this.queries = queries;\n    this.postUser = this.postUser.bind(this);\n    this.loginUser = this.loginUser.bind(this);\n    this.getAUser = this.getAUser.bind(this);\n  }\n\n\n  /** An API for adding a new user:\n  *  POST: api/v1/auth/signup\n  *  Takes 2 parameters\n  *  @param {object} req the first parameter\n  *  @param  {object} res the second parameter\n  *\n  *  @returns {object} return an object\n  *\n  * The logic behind this was inspired by 'PostreSQL and NodeJS' article on 'www.mherman.com'\n  * see full link https://mherman.org/blog/2015/02/12/postgresql-and-nodejs/\n  */\n  postUser(req, res) {\n    const salt = this.bcrypt.genSaltSync(10);\n    const registeredUser = [];\n    const addUser = this.queries.insertUser(req, salt, this.bcrypt);\n\n    addUser.on('row', (row) => { registeredUser.push(row); });\n    addUser.on('end', () => {\n      req.done();\n      if (addUser) {\n        const [user] = registeredUser;\n\n        const token = this.jwt.sign(\n          { user_id: user.user_id },\n          this.env.SECRET_KEY, { expiresIn: 60 * 60 }\n        );\n\n        return res.status(201).send({ user, token });\n      }\n\n      return res.status(500).send({\n        errorMessage: 'Internal server error'\n      });\n    });\n  }\n\n\n  /**\n   *  An API for logging into the app\n   *  POST: /api/v1/auth/login\n   *  Takes 2 parameters\n   *  @param {object} req the first parameter\n   *  @param  {object} res the second parameter\n   *\n   *  @returns {object} return an object\n   */\n  loginUser(req, res) {\n    const { user, body } = req;\n    const token = this.jwt.sign(\n      { user_id: user.user_id },\n      this.env.SECRET_KEY, { expiresIn: 60 * 60 }\n    );\n\n    if (this.bcrypt.compareSync(body.password.trim(), user.password)) {\n      res.status(200).send({ user, token });\n    } else {\n      res.status(404).send({ errorMessage: 'Invalid email or password' });\n    }\n  }\n\n  /**\n   *  An API for fetching a single user from the app\n   *  POST: /api/v1/user\n   *  Takes 2 parameters\n   *  @param {object} req the first parameter\n   *  @param  {object} res the second parameter\n   *\n   *  @returns {object} return an object\n   */\n  getAUser(req, res) {\n    const entries = [];\n    const getEntries = this.queries.getAllEntries(req);\n\n    getEntries.on('row', (row) => { entries.push(row); });\n    req.user.entries = entries;\n\n    getEntries.on('end', () => {\n      req.done();\n      return res.status(200).send(req.user);\n    });\n  }\n}\n"]}